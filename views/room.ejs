<!doctype html>
<html>
  <head>
    <title>Socket.IO chat</title>
<script src="https://ajax.googleapis.com/ajax/libs/jquery/2.1.4/jquery.min.js"></script>
<script src="https://cdn.socket.io/socket.io-1.3.7.js"></script>
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/js/bootstrap.min.js"></script>
<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/css/bootstrap.min.css" integrity="sha384-1q8mTJOASx8j1Au+a5WDVnPi2lkFfwwEAa8hDDdjZlpLegxhjVME1fgjWPGmkzs7" crossorigin="anonymous">
<link rel="stylesheet" href="../stylesheets/style.css">

  </head>
  <body>
  <h3>A ROOM</h3>

  <input id="playerName" type="text" class="form-control" placeholder="Add a Player Name " aria-describedby="basic-addon1">

<select class="form-control" id="team">
    <option value="team1">Team 1</option>
    <option value="team2">Team 2</option>
</select>

  <button id="addPlayer"type="button" class="btn btn-primary">Add Player</button>
  <button id="startGame"type="button" class="btn btn-primary">StartGame</button>

  <table>
  <thead>
    <tr id="playerInfo">
    <th>PlayerName</th>
    <th>Teams</th>
    <th>Remaining Cards</th>
    <th>Current</th>
    </tr>
  </thead>
  <tbody>
  </tbody>
  </table>

  <div id="cardsontable" class="row">
  </div>
  <br>
  <br>
  <div id="hand" class="row">
  </div>
  <button id="sendCards"type="button" class="btn btn-primary" disabled="disabled">Send Cards</button>
  <button id="pass"type="button" class="btn btn-primary" disabled="disabled">Pass</button>

<script>
$(function() {
  var id;
  var selectedCard;
  var cardsOnTable;
  var host ="http://localhost:50000";
  var roomlist = io.connect(host+"/roomlist");
  var games = io.connect(host +"/games");
  var generalSocket = io.connect();
  roomlist.on("playerUpdate",function(data){
    $("#roomList").html("");
    var procData=JSON.parse(data);
    for (var i =0;i<procData.length;i++){
      var str='<a href=room/'+procData[i].roomNumber +'><li>' +procData[i].roomName + procData[i].playerList.length+'</li></a>'
      $("#roomList").prepend(str);
    }
  })

  games.on('connect', function(socket){
        id =io().id;
  });

  var room =<%-JSON.stringify(room)%>
  var roomNumber=room.roomNumber;

  $("#addPlayer").click(function(){
    var playerName=$("#playerName").val();
    var teamNumber = $('#team').find(":selected").val();
    var player={};
    player.name=playerName;
    player.team=teamNumber;
    if(playerName!=''){
      games.emit('joinRoom', {roomNumber:roomNumber, player:player});
      $("#playerName").val('');
    }
  });

  games.on("updateClientList",function(data){
    roomlist.emit('updatePlayer',{roomNumber:roomNumber, playerList:data});
    $("tbody").html("");
    for(var i=0;i<data.length;i++){
      $( "tbody" ).append( "<tr id='"+data[i].id+"'><td>"+data[i].player.name+"</td><td>"+data[i].player.team+"</td><td></td><td></td> </tr>");
    }
    localStorage.setItem("playerList", JSON.stringify(data));
  });

  setInterval(function(){
    games.emit('updateList',{roomNumber:roomNumber});
  }, 5000);

  $("#startGame").click(function(){
    var playerList= JSON.parse(localStorage.getItem("playerList"));
    if(playerList.length==4){
        games.emit('startGame',{roomNumber:roomNumber,playerList:playerList});
      }
  });

  games.on("initiateHand",function(data){
    for (var i =0;i<data.length;i++){
    $("#hand").append("<div class='card'> <h3>"+data[i]+"</h3>  <input class='checkbox' name='"+data[i]+"'type='checkbox'></div>");
    }
    $(".checkbox").change(function() {
          getAllCheckedCard();
          if(checkLegalCard()){
              $("#sendCards").prop('disabled', false);
          }
          else{
            $("#sendCards").prop('disabled', true);
          }
      });
  })

  function getAllCheckedCard(){
    var arr=$(':checked');
    selectedCard=[];
    for(var i=1;i<arr.length;i++){
      selectedCard.push(arr[i].name);
    }
  }

  $("#sendCards").click(function(){
      games.emit('sendCards',{cards:selectedCard,id:JSON.parse(localStorage.getItem("id"))});
      $(':checked').parent().remove();
      $("#sendCards").prop('disabled', true);
      $("#pass").prop('disabled', true);
  });

  games.on("distributeCards",function(data){
    console.log("cardRCVD");
    cardsOnTable=data.cards;
    for (var i =0;i<cardsOnTable.length;i++){
      $("#cardsontable").append("<div class='card'> <h3>"+cardsOnTable[i]+"</h3></div>");
    };
    if(data.id==id){
      $("#pass").prop('disabled', false);
    }
  })

})
</script>
  </body>
</html>